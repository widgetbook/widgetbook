# Widgetbook v4: SAM

<Warning>
  The rest of the pages in this docs are not yet updated to reflect the new SAM
  architecture. They will be updated soon.
</Warning>

<Warning>
  This version is still in alpha stage, and it's highly unstable. Breaking
  changes can happen at any time. Use it at your own risk.
</Warning>

## What's different in v4?

| Feature             | v3                                                  | v4                                                                                        |
| ------------------- | --------------------------------------------------- | ----------------------------------------------------------------------------------------- |
| Type-safety         | Knobs were not type-safe as they depend on the name | Args are type-safe and generated based on the Widget's constructor or a custom interface. |
| Golden Tests        | Only via Widgetbook Cloud                           | Supported natively via `Scenario`s.                                                       |
| Interaction Testing | Not supported in Widgetbook Cloud                   | Supported using `Scenario.run` method.                                                    |
| Component-snapshot  | The default snapshot size was always iPhone SE      | The default snapshot size is as big as the component.                                     |

## Project Bootstrap

1. Create a new Flutter project inside your app's directory:

   ```bash
   ## All platforms
   flutter create widgetbook --empty

   ## Certain platforms
   flutter create widgetbook --empty --platforms=web,macos
   ```

1. To avoid naming conflict with the [Widgetbook pub package](https://pub.dev/packages/widgetbook), change the project `name` to `widgetbook_workspace` inside the `widgetbook/pubspec.yaml` file:

   ```diff
   - name: widgetbook
   + name: widgetbook_workspace
   ```

1. Add the following dependencies to your `widgetbook` project:

   ```bash
   flutter pub add widgetbook dev:build_runner dev:widgetbook_generator dev:widgetbook_test
   ```

1. Add your app as a path dependency to the `widgetbook/pubspec.yaml` file:

   ```yaml
   dependencies:
     your_app:
       path: ../
   ```

1. Create a `widgetbook/lib/widgetbook.config.dart` file:

   ```dart
   import 'package:flutter/material.dart';
   import 'package:widgetbook/widgetbook.dart';

   import 'components.book.dart'; // Will be generated later

   final config = Config(
     components: components,
     addons: [
       ViewportAddon([
         Viewports.none,
         IosViewports.iPhone13,
         const ViewportData.constrained(
           name: '800w',
           pixelRatio: 2,
           maxWidth: 800,
           platform: TargetPlatform.iOS,
         ),
       ]),
       MaterialThemeAddon({
         'Dark': ThemeData.dark(),
         'Light': ThemeData.light(),
       }),
     ],
   );
   ```

1. Replace `widgetbook/lib/main.dart` contents with:

   ```dart
   import 'package:widgetbook/widgetbook.dart';

   import 'widgetbook.config.dart';

   void main() => runWidgetbook(config);
   ```

1. Create `widgetbook/test/main_test.dart` file:

   ```dart
   import 'package:widgetbook_workspace/widgetbook.config.dart';
   import 'package:widgetbook_test/widgetbook_test.dart';

   Future<void> main() async {
     await testWidgetbook(config);
   }
   ```

## Create your first Component

A `Component` is a representation of a Widget you want to showcase in Widgetbook. Each `Component` can have multiple stories.
Let's start by cataloging a simple widget.

1. Create a new widget in your app, e.g. `lib/widgets/custom_button.dart`:

   ```dart
   import 'package:flutter/material.dart';

   class CustomButton extends StatelessWidget {
     final String label;
     final VoidCallback onPressed;

     const CustomButton({
       super.key,
       required this.label,
       required this.onPressed,
     });

     @override
     Widget build(BuildContext context) {
       return ElevatedButton(
          onPressed: onPressed,
          child: Text(label),
        );
      }
    }
   ```

1. Create a new file `widgetbook/lib/custom_button.stories.dart`:

   ```dart
   import 'package:widgetbook/widgetbook.dart';
   import 'package:your_app/widgets/custom_button.dart';

   part 'custom_button.stories.book.dart';

   const meta = Meta<CustomButton>();
   ```

1. Run `dart run build_runner build` to generate the boilerplate code.

## Create your first Story

A story is a variant of a `Component`. For example, if the component is a button, its stories can be "primary button", "secondary button", "disabled button", etc.
Now you can start writing stories for the `CustomButton` component. A story must start with `$`.

```dart
import 'package:widgetbook/widgetbook.dart';
import 'package:your_app/widgets/custom_button.dart';

part 'custom_button.stories.book.dart';

const meta = Meta<CustomButton>();

final $Default = CustomButtonStory();  // [!code highlight]
```

## Create your first Scenario

A `Scenario` is like a golden test of your story with certain `args` and `mode`.

```dart
import 'package:widgetbook/widgetbook.dart';
import 'package:your_app/widgets/custom_button.dart';

part 'custom_button.stories.book.dart';

const meta = Meta<CustomButton>();

final $Default = CustomButtonStory(
  scenarios: [
    CustomButtonScenario(
      name: 'Long Label',
      modes: [MaterialThemeMode('Light', ThemeData.light())],
      args: CustomButtonArgs.fixed(
        label: 'This is a very long label',
        onPressed: () {},
      ),
      run: (tester, args) async {
        // You can simulate interactions here
        // For example, tap the button
        // await tester.tap(find.text(args.label.value));

        // Or you can also expect certain behaviors
        // expect(...);
      },
    ),
  ],
);
```

To run these scenarios, you need to run `flutter test` then check your `widgetbook/build/.widgetbook` folder for the generated screenshots.

If you want to define global scenarios for all stories in you widgetbook, you can define them in your `widgetbook.config.dart` file:

```dart
final config = Config(
  // ...
  scenarios: [
    ScenarioDefinition(
      name: 'Dark',
      modes: [MaterialThemeMode('Dark', ThemeData.dark())],
    ),
    ScenarioDefinition(
      name: 'Light',
      modes: [MaterialThemeMode('Light', ThemeData.light())],
    ),
  ],
);
```

## More Examples

You can find more examples in our [sandbox app](https://github.com/widgetbook/widgetbook/tree/v4/sandbox).

- Instead of generating args based on the constructor, you can create a custom `Args` class to have more control over the args ([example](https://github.com/widgetbook/widgetbook/blob/v4/sandbox/lib/%5Bsam%5D/label_badge.stories.dart))
- Change the generated component name/path from `meta`. ([example](https://github.com/widgetbook/widgetbook/blob/026a408401be42a8a5a9cb430e5bf6946445245d/sandbox/lib/settings/nullable_setting.stories.dart#L8))
- Add text-based (markdown coming soon) docs to your component. ([example](https://github.com/widgetbook/widgetbook/blob/026a408401be42a8a5a9cb430e5bf6946445245d/sandbox/lib/%5Bsam%5D/generic_text.stories.dart#L10-L13))
- Use `Scenario.run` to simulate interactions and verify behaviors. ([example](https://github.com/widgetbook/widgetbook/blob/026a408401be42a8a5a9cb430e5bf6946445245d/sandbox/lib/%5Bsam%5D/counter.stories.dart#L22-L29))
- If your story is expanding in height/width, you need to provide a `ViewportMode` to constrain it. ([example](https://github.com/widgetbook/widgetbook/blob/026a408401be42a8a5a9cb430e5bf6946445245d/sandbox/lib/settings/nullable_setting.stories.dart#L22-L33))
- If your widget has a non-primitive parameter, then you need to create a custom `Args` class. ([example](https://github.com/widgetbook/widgetbook/blob/026a408401be42a8a5a9cb430e5bf6946445245d/sandbox/lib/%5Bsam%5D/types_table.stories.dart#L57-L100))
